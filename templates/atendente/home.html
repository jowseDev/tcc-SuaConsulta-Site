<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sua Consulta</title>
</head>
<body>
    
    <h1>Bem vindo, <span th:text="${nome}"></span></h1>

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <div id="calendar" style="max-width: 1200px; height: 500px; margin: auto;"></div>

    <button onclick="window.location.href='/auth/atendente/agendar'">AGENDAR CONSULTA</button>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const colorMap = {}; // Fix color mapping outside the events function

            const generateLightColor = () => {
                const r = Math.floor(Math.random() * 128 + 128);
                const g = Math.floor(Math.random() * 128 + 128);
                const b = Math.floor(Math.random() * 128 + 128);
                return `rgb(${r}, ${g}, ${b})`;
            };

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridDay,timeGridWeek,listWeek'
                },
                views: {
                    dayGridMonth: { buttonText: 'Mês' },
                    timeGridDay: { buttonText: 'Dia' },
                    timeGridWeek: { buttonText: 'Semana' },
                    listWeek: { buttonText: 'Lista Semanal' },
                },
                events: async function(fetchInfo, successCallback, failureCallback) {
                    try {
                        const response = await axios.get('/api/consultas/listar');
                        const consultas = response.data;

                        const events = consultas.map(consulta => {
                            if (!colorMap[consulta.nomeMedico]) {
                                colorMap[consulta.nomeMedico] = generateLightColor();
                            }
                            return {
                                title: consulta.nomeMedico,
                                start: consulta.data,
                                color: colorMap[consulta.nomeMedico],
                                extendedProps: {
                                    nomePaciente: consulta.nomePaciente,
                                    observacoes: consulta.observacoes
                                }
                            };
                        });

                        successCallback(events);
                    } catch (error) {
                        console.error('Erro ao carregar consultas:', error);
                        failureCallback(error);
                    }
                },
                eventClick: function(info) {
                    const { nomePaciente, observacoes } = info.event.extendedProps;

                    Swal.fire({
                        title: 'Detalhes da Consulta',
                        html: `
                            <p><strong>Médico:</strong> ${info.event.title}</p>
                            <p><strong>Paciente:</strong> ${nomePaciente}</p>
                            <p><strong>Observações:</strong> ${observacoes}</p>
                        `,
                        icon: 'info',
                        confirmButtonText: 'Fechar'
                    });
                },
                eventTimeFormat: { // Format time to always show hours and minutes
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: false
                },
                allDayText: '', // Translate "All Day" to Portuguese
                buttonText: {
                    today: 'Hoje', // Translate "Today" to Portuguese
                    day: 'Dia', // Translate "Day" to Portuguese
                    week: 'Semana', // Translate "Week" to Portuguese
                    listWeek: 'Lista Semanal' // Correct translation for "listWeek"
                },
                eventDidMount: function(info) {
                    // Apply card-like styling to events
                    info.el.style.backgroundColor = info.event.backgroundColor || info.event.color;
                    info.el.style.borderRadius = '8px';
                    info.el.style.padding = '5px'; // Reduce padding for smaller height
                    info.el.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.2)';
                    info.el.style.color = 'black'; // Ensure text is readable
                    info.el.style.textAlign = 'justify'; // Justify text inside the item
                    info.el.style.marginBottom = '5px'; // Add spacing between items
                    info.el.style.cursor = 'pointer'; // Change cursor to pointer on hover
                }
            });

            calendar.render();
        });
    </script>

</body>
</html>