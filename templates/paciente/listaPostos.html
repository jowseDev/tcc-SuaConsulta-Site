<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sua Consulta</title>
</head>
<body>

    <!-- Container oculto apenas para montar os cards (sem mostrar na tela) -->
<div id="postos-container" style="display: none;"></div>

<!-- Botão para abrir o modal -->
<button onclick="mostrarPostos()">Mostrar Postos</button>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    let postosData = [];
    let medicosData = [];

    // Carrega os dados ao iniciar
    axios.get('/api/agendamentos/postos')
        .then(response => {
            postosData = response.data;
            const container = document.getElementById('postos-container');
            container.innerHTML = '';

            postosData.forEach((posto, index) => {
                const card = document.createElement('div');
                card.classList.add('posto-card');
                card.style.cssText = `
                    border: 1px solid #ccc;
                    border-radius: 8px;
                    padding: 16px;
                    width: 200px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    text-align: center;
                `;

                const title = document.createElement('h3');
                title.textContent = posto.nome;
                card.appendChild(title);

                const bairro = document.createElement('p');
                bairro.textContent = "Bairro: " + posto.bairro;
                bairro.style.cssText = `font-size: 0.9em; color: #555;`;
                card.appendChild(bairro);

                const button = document.createElement('button');
                button.textContent = "Selecionar";
                button.setAttribute('data-posto-id', posto.id);
                button.setAttribute('data-index', index);
                button.classList.add('selecionar-posto');
                button.style.marginTop = "8px";
                card.appendChild(button);

                container.appendChild(card);
            });
        })
        .catch(error => {
            console.error("Erro ao buscar os postos:", error);
        });

    // Função para mostrar os cards de postos
    function mostrarPostos() {
        const htmlPostos = document.getElementById('postos-container').innerHTML;

        Swal.fire({
            title: 'Selecione um Posto',
            html: `<div id="postos-modal-container" style="display: flex; flex-wrap: wrap; gap: 16px;">${htmlPostos}</div>`,
            width: '900px',
            showCloseButton: true,
            showConfirmButton: false,
            didOpen: () => {
                document.querySelectorAll('.selecionar-posto').forEach(button => {
                    button.addEventListener('click', () => {
                        const index = button.getAttribute('data-index');
                        const posto = postosData[index];

                        carregarMedicos(posto.id, posto.nome);
                    });
                });
            }
        });
    }

    // Carregar médicos do posto e mostrar cards
    function carregarMedicos(postoId, nomePosto) {
        axios.get(`/api/agendamentos/medicos/${postoId}`)
            .then(response => {
                medicosData = response.data;

                const htmlMedicos = medicosData.map((medico, index) => `
                    <div class="medico-card" style="border: 1px solid #ccc; border-radius: 8px; padding: 16px; width: 200px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                        <h4>${medico.nome}</h4>
                        <p style="font-size: 0.9em; color: #555;">Especialidade: ${medico.especialidade}</p>
                        <button class="selecionar-medico" data-index="${index}" style="margin-top: 8px;">Selecionar</button>
                    </div>
                `).join('');

                Swal.fire({
                    title: `Médicos do ${nomePosto}`,
                    html: `<div id="medicos-container" style="display: flex; flex-wrap: wrap; gap: 16px;">${htmlMedicos}</div>`,
                    width: '900px',
                    showCloseButton: true,
                    showConfirmButton: false,
                    didOpen: () => {
                        document.querySelectorAll('.selecionar-medico').forEach(button => {
                            button.addEventListener('click', () => {
                                const index = button.getAttribute('data-index');
                                const medico = medicosData[index];
                                mostrarFormularioFinal(medico, postoId);
                            });
                        });
                    }
                });
            })
            .catch(error => {
                console.error("Erro ao buscar os médicos:", error);
            });
    }

    // Mostrar inputs de data, hora e descrição
    function mostrarFormularioFinal(medico, postoId) {
    Swal.fire({
        title: `Agendar com ${medico.nome}`,
        html: `
            <label>Data:</label>
            <input type="date" id="dataConsulta" class="swal2-input">
            <label>Horário:</label>
            <input type="time" id="horaConsulta" class="swal2-input">
            <label>Observações:</label>
            <textarea id="descricaoConsulta" class="swal2-textarea" placeholder="Descreva o motivo do agendamento"></textarea>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Agendar',
        preConfirm: () => {
            const data = document.getElementById('dataConsulta').value;
            const hora = document.getElementById('horaConsulta').value;
            const observacoes = document.getElementById('descricaoConsulta').value;

            if (!data || !hora || !observacoes) {
                Swal.showValidationMessage('Todos os campos são obrigatórios.');
                return false;
            }

            const dataCompleta = `${data}T${hora}`;

            const payload = {
                medicoId: medico.id,
                postoId: postoId,
                data: dataCompleta,
                observacoes: observacoes
            };

            console.log("Enviando payload:", payload);
            return axios.post('/api/consultas/agendar', payload)
                .then(response => response.data)
                .catch(error => {
                    Swal.showValidationMessage('Erro ao agendar: ' + (error.response?.data || 'Erro desconhecido.'));
                    return false;
                });
        }
    }).then(result => {
        if (result.isConfirmed && result.value) {
            Swal.fire({
                icon: 'success',
                title: 'Agendamento realizado',
                text: `Consulta com ${medico.nome} foi agendada com sucesso.`,
            });
            window.location.href='/auth/paciente/home'
        }
    });
}

    
</script>

</body>
</html>