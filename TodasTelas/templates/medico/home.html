<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sua Consulta</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    
    <h1>Bem vindo, Dr(a). <span th:text="${nome}"></span></h1>
    
    <div id="consulta-info" style="display: flex; justify-content: center; margin: 16px 0;"></div>
    <p id="consulta-detalhes" style="text-align: center;">Carregando informações das próximas consultas...</p>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            axios.get('/api/medico/proximasConsultas')
                .then(function (response) {
                    const consultas = response.data;
                    const consultaInfoDiv = document.getElementById('consulta-info');
                    const consultaDetalhesP = document.getElementById('consulta-detalhes');

                    if (consultas && consultas.length > 0) {
                        consultaDetalhesP.style.display = 'none'; // Hide the loading text

                        const card = document.createElement('div');
                        card.style.border = '1px solid #ccc';
                        card.style.borderRadius = '8px';
                        card.style.padding = '16px';
                        card.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
                        card.style.width = '90%';
                        card.style.maxWidth = '1200px';
                        card.style.backgroundColor = '#f9f9f9';

                        const list = document.createElement('ul');
                        list.style.listStyle = 'none';
                        list.style.padding = '0';

                        consultas.forEach(function (consulta) {
                            let dataConsulta;
                            try {
                                dataConsulta = new Date(consulta.dataConsulta);
                                if (isNaN(dataConsulta)) {
                                    throw new Error("Invalid date format");
                                }
                            } catch (error) {
                                console.error("Invalid date format for consulta:", consulta, error);
                                return;
                            }

                            const agora = new Date();
                            const diferenca = dataConsulta - agora;

                            let detalhes = '';
                            let botaoTexto = 'Ver detalhes';
                            let botaoAcao = `verDetalhes(${JSON.stringify(consulta).replace(/"/g, '&quot;')})`;

                            if (diferenca > 0) {
                                const dias = Math.floor(diferenca / (1000 * 60 * 60 * 24));
                                const horas = Math.floor((diferenca % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                const minutos = Math.floor((diferenca % (1000 * 60 * 60)) / (1000 * 60));

                                detalhes = `Faltam ${dias} dias, ${horas} horas e ${minutos} minutos.`;
                            } else if (agora >= dataConsulta && agora <= new Date(dataConsulta.getTime() + 30 * 60 * 1000)) {
                                detalhes = `A consulta está em andamento.`;
                                botaoTexto = 'Ir para a consulta';
                                botaoAcao = `window.location.href='/auth/medico/consulta?nomePessoa=${encodeURIComponent(consulta.nomePessoa)}&idade=${encodeURIComponent(new Date().getFullYear() - new Date(consulta.dataNascPessoa).getFullYear())}&sexo=${encodeURIComponent(consulta.sexoPessoa)}&observacoes=${encodeURIComponent(consulta.observacoes)}&id=${encodeURIComponent(consulta.id)}'`;
                            } else {
                                detalhes = `Essa consulta já passou.`;
                            }

                            const listItem = document.createElement('li');
                            listItem.style.borderBottom = '1px solid #ddd';
                            listItem.style.padding = '8px 0';
                            listItem.style.display = 'flex';
                            listItem.style.justifyContent = 'space-between';
                            listItem.style.alignItems = 'center';

                            listItem.innerHTML = `
                                <div>
                                    <p><strong>Consulta com:</strong> ${consulta.nomePessoa}</p>
                                    <p><strong>Data:</strong> ${dataConsulta.toLocaleString('pt-BR')}</p>
                                    <p>${detalhes}</p>
                                    <p><strong>Observações:</strong> ${consulta.observacoes}</p>
                                </div>
                                <button style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="${botaoAcao}">${botaoTexto}</button>
                            `;

                            list.appendChild(listItem);
                        });

                        card.appendChild(list);
                        consultaInfoDiv.appendChild(card);
                    } else {
                        consultaDetalhesP.innerText = "Você não tem consultas agendadas.";
                    }
                })
                .catch(function (error) {
                    console.error(error);
                    document.getElementById('consulta-detalhes').innerText = "Erro ao carregar informações das consultas.";
                });
        });

        function verDetalhes(consulta) {
            Swal.fire({
                title: 'Detalhes da Consulta',
                html: `
                    <p><strong>Data:</strong> ${new Date(consulta.dataConsulta).toLocaleString('pt-BR')}</p>
                    <p><strong>Paciente:</strong> ${consulta.nomePessoa}</p>
                    <p><strong>Data de Nascimento:</strong> ${new Date(consulta.dataNascPessoa).toLocaleDateString('pt-BR')}</p>
                    <p><strong>Sexo:</strong> ${consulta.sexoPessoa}</p>
                    <p><strong>Observações:</strong> ${consulta.observacoes}</p>
                `,
                icon: 'info',
                confirmButtonText: 'Fechar'
            });
        }
    </script>

    <button onclick="window.location.href='/auth/medico/atendimentos'">Consultas atendidas</button>
    <button></button>
</body>
</html>